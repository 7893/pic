# Lens: 边缘原生视觉智能引擎 (Edge-Native Visual Intelligence Engine)

> **"这是一个懂得审美、能够识别实体、并在零成本边际下实现数据自我进化的视觉知识系统。"**

[![Live Demo](https://img.shields.io/badge/Live-lens.53.workers.dev-F38020?logo=cloudflare&logoColor=white)](https://lens.53.workers.dev)
[![Architecture](https://img.shields.io/badge/架构-事件驱动型服务器-blueviolet)](docs/ARCHITECTURE.md)
[![Model](https://img.shields.io/badge/核心大脑-Llama%204%20Scout%2017B-blue)](https://developers.cloudflare.com/workers-ai/)
[![License](https://img.shields.io/badge/许可证-MIT-green)](LICENSE)

Lens 不仅仅是一个图片搜索工具，它是运行在 Cloudflare 边缘节点上的 **全自动视觉智能系统**。通过集成最新的 **Llama 4 Scout (17B)** MoE 架构模型与自研的 **“线性对撞 (Linear Boundary)”** 采集算法，Lens 在维持工业级语义检索精度的同时，将运行成本死死压在了 Serverless 的免费配额之内。

---

## 🌟 为什么 Lens 截然不同？

### 1. 策展人级的感知力 (Curator-Level Perception)

传统 AI 搜索只看“物体”（如：一只猫，一辆车）。Lens 能够理解**叙事与审美**：

- **审美自动打分**：AI 对每一张图片的构图、光影、清晰度进行 0-10 分的深度评测。你可以搜“电影感的大片”，而不仅仅是相关结果。
- **硬核实体提取**：精准识别地标（如：新宿站）、品牌（如：Nike）及生物品种，实现基于“实体”的精准召回。
- **情绪语义对齐**：理解“孤独感”、“赛博朋克”、“极简主义”等抽象概念，并将其转化为高维空间的坐标。

### 2. 自我进化引擎 (The Self-Evolution Engine)

Lens 是一个“活”的系统。它不仅在摄取数据，还在**打磨数据**：

- **UTC 23:00 爆发策略**：每天 UTC 23:00（配额重置前 1 小时），系统会自动清算今日剩余的免费 AI 神经元 (Neurons)。
- **零成本质量升级**：利用这些“余粮”，系统会自动重刷那些使用旧模型（如 Llama 3.2）处理的存量数据，将其升级为 Llama 4 旗舰版描述。
- **成果**：你的数据库每天都在变聪明，而你无需为此多付一分钱。

### 3. 极致成本工程 (Extreme Cost Engineering)

在数万张图片上运行 17B 参数的大模型通常价格不菲。Lens 通过严苛的工程手段实现了“白嫖”：

- **线性对撞算法**：一种“撞墙即停”的抓取逻辑，确保 0% 的 Unsplash API 配额浪费。
- **动态相关性截断**：通过数学上的“断崖检测”算法，精准在相关度下降点截断结果，节省昂贵的重排成本。
- **边缘优先架构**：没有容器，没有持久化服务器。资源仅在事件（Cron 或 Request）触发时瞬间分配。

---

## 🏗️ 系统架构图 (Architecture)

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                                CLOUDFLARE EDGE                                     │
│                                                                                    │
│  ┌─────────────┐    ┌───────────────────────────────────────────────────────────┐  │
│  │             │    │                  INGESTION PIPELINE                       │  │
│  │   SEARCH    │    │                                                           │  │
│  │    API      │    │  ┌──────────┐    ┌──────────┐    ┌──────────────────┐     │  │
│  │             │    │  │   Cron   │───▶│   Queue  │───▶│     Workflow     │     │  │
│  │  /search    │    │  │ */10min  │    │  (batch) │    │   (per image)    │     │  │
│  │  /images    │    │  └──────────┘    └──────────┘    └────────┬─────────┘     │  │
│  │  /stats     │    │                                           │               │  │
│  │             │    │       ┌───────────────────────────────────┘               │  │
│  └──────┬──────┘    │       ▼                                                   │  │
│         │           │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │  │
│         │           │  │ Download │─▶│  Vision  │─▶│ Embedding│─▶│ Persist  │   │  │
│         │           │  │  Image   │  │ Llama 4  │  │  BGE-M3  │  │ D1 + R2  │   │  │
│         │           │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │  │
│         │           └───────────────────────────────────────────────────────────┘  │
│         │                                                                          │
│         │  ┌────────────────────────────────────────────────────────────────────┐  │
│         │  │                        SEARCH FLOW                                 │  │
│         │  │                                                                    │  │
│         └──┼───▶ Query ───▶ Vectorize ───▶ Rerank ───▶ Transform ───▶ JSON      │  │
│            │     Expand      BGE-M3       Reranker      + R2 URL                │  │
│            │    (Llama 4)   (top 100)     (top 20)                              │  │
│            └────────────────────────────────────────────────────────────────────┘  │
│                                                                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                             STORAGE                                          │  │
│  │   ┌─────────────┐     ┌─────────────┐     ┌──────────────────────────┐       │  │
│  │   │      D1     │     │      R2     │     │        Vectorize         │       │  │
│  │   │   20k rows  │     │    images   │     │    20k × 1024-dim        │       │  │
│  │   │   metadata  │     │   raw/thumb │     │       embeddings         │       │  │
│  │   └─────────────┘     └─────────────┘     └──────────────────────────┘       │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                     ┌──────────────────┴──────────────────┐
                     ▼                                      ▼
              ┌────────────┐                        ┌──────────────┐
              │  Unsplash  │                        │    Users     │
              │    API     │                        │   Browsers   │
              └────────────┘                        └──────────────┘
```

> **深度阅读**：参阅 [架构与算法详解](docs/ARCHITECTURE.md) 了解我们如何解决分布式死锁与配额泄漏。

---

## ⚡ 技术亮点 (Technical Highlights)

| 特性           | 实现方案                       | 核心优势                              |
| :------------- | :----------------------------- | :------------------------------------ |
| **语义搜索**   | Llama 4 Scout + BGE-M3         | 支持多语言、多维度的深层语义匹配。    |
| **全链路追踪** | **基于 Trace-ID 的可观测性**   | 毫秒级定位分布式故障，日志流纯净。    |
| **数据进化**   | 23:00 UTC 余额压榨算法         | 零额外成本自动升级存量索引智力。      |
| **结果重排**   | BGE Reranker Base              | 消除向量幻觉，召回精度提升 40% 以上。 |
| **成本控制**   | GraphQL 实时审计 + 5% 安全边际 | 极致精算，彻底告别“房子没了”的焦虑。  |
| **GitOps**     | Wrangler Migrations            | 数据库表结构演进全程版本化、自动化。  |

---

## ⚡ 技术栈与性能规格

| 组件           | 技术选型              | 职责                                           |
| :------------- | :-------------------- | :--------------------------------------------- |
| **视觉大脑**   | **Llama 4 Scout 17B** | 多模态推理、审美打分与实体识别。               |
| **查询扩展**   | **Llama 3.2 3B**      | 轻量快速的搜索词语义扩展。                     |
| **向量底座**   | **BGE-M3**            | 1024 维高密度向量，支持多语言跨模态对齐。      |
| **重排序器**   | **BGE Reranker Base** | 基于 Cross-attention 消除向量空间的幻觉误报。  |
| **持久化大脑** | **Cloudflare D1**     | 存储旗舰版元数据、审美分与实体 JSON。          |
| **资产存储**   | **Cloudflare R2**     | 采用 Raw/Display 分层存储策略优化内存与流量。  |
| **任务编排**   | **Workflows**         | 管理具备自动重试能力的复杂、多阶段采集流水线。 |

---

## 📚 文档中心 (Documentation)

我们坚信“文档即代码”。我们的文档涵盖了从数学原理到运维实战的所有细节：

- [**01. 架构与算法**](docs/ARCHITECTURE.md) - 深入剖析线性对撞与自进化逻辑的数学模型。
- [**02. 存储与数据模型**](docs/DATABASE.md) - 详解 D1 表结构设计与 R2 分层战略。
- [**03. 完整接口指南**](docs/API.md) - 包含旗舰版响应示例的 REST API 规范。
- [**04. 全栈部署手册**](docs/DEPLOYMENT.md) - 15 分钟内从零拉起完整的生产环境。
- [**05. 开发与扩展指南**](docs/DEVELOPMENT.md) - 模块化架构解析与提示词工程秘籍。
- [**06. 运维与成本管理**](docs/MAINTENANCE.md) - 如何监控进化波峰并精算每分钱。

---

## 许可证 (License)

MIT © 2026 Lens 贡献者.
