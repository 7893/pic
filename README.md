# ğŸ–¼ï¸ Pic - AI Photo Gallery

[![Cloudflare Workers](https://img.shields.io/badge/Cloudflare-Workers-orange)](https://workers.cloudflare.com/)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

åŸºäº Cloudflare æ— æœåŠ¡å™¨ç”Ÿæ€çš„è‡ªåŠ¨åŒ–å›¾ç‰‡æ”¶é›†å’Œ AI åˆ†ç±»ç³»ç»Ÿã€‚ä» Unsplash è·å–ç…§ç‰‡ï¼Œä½¿ç”¨ AI æ™ºèƒ½åˆ†ç±»ï¼Œå­˜å‚¨åœ¨ R2ï¼Œå…ƒæ•°æ®ä¿å­˜åœ¨ D1ã€‚

## âœ¨ ç‰¹æ€§

- ğŸ¤– **è‡ªåŠ¨æ”¶é›†**ï¼šæ¯å°æ—¶ä» Unsplash è·å–æœ€æ–°ç…§ç‰‡
- ğŸ§  **AI åˆ†ç±»**ï¼šä½¿ç”¨ Cloudflare AI æ¨¡å‹æ™ºèƒ½åˆ†ç±»
- ğŸ“¦ **æ— æœåŠ¡å™¨**ï¼š100% Cloudflare ç”Ÿæ€ï¼ˆWorkers + D1 + R2 + Workflowsï¼‰
- ğŸ”„ **å»é‡æœºåˆ¶**ï¼šåŸºäºæ¸¸æ ‡çš„å¢é‡åŒæ­¥ï¼Œé¿å…é‡å¤
- ğŸ“Š **å®æ—¶ç»Ÿè®¡**ï¼šåˆ†ç±»åˆ†å¸ƒã€å¤„ç†çŠ¶æ€ã€API é…é¢ç›‘æ§
- ğŸ¯ **å®¹é”™å¤„ç†**ï¼šWorkflow æ­¥éª¤çº§é‡è¯•ï¼Œè‡ªåŠ¨æ¢å¤
- ğŸ’¾ **è‡ªåŠ¨æ¸…ç†**ï¼šä¿ç•™æœ€æ–° 4,000 å¼ ç…§ç‰‡ï¼Œè‡ªåŠ¨åˆ é™¤æ—§æ•°æ®
- ğŸ”’ **é…é¢ç®¡ç†**ï¼šAPI è°ƒç”¨é™åˆ¶å’Œè‡ªåŠ¨é‡ç½®æœºåˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Node.js 22.20.0ï¼ˆå‚è§ `.nvmrc` æˆ– `.tool-versions`ï¼‰
- Cloudflare è´¦æˆ·ï¼ˆå¯ç”¨ Workersã€D1ã€R2ã€AIã€Queuesï¼‰
- Unsplash API Keyï¼ˆ[å…è´¹ç”³è¯·](https://unsplash.com/developers)ï¼‰

### ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | è·å–æ–¹å¼ |
|--------|------|----------|
| `UNSPLASH_API_KEY` | Unsplash API å¯†é’¥ | [æ³¨å†Œåº”ç”¨](https://unsplash.com/oauth/applications) |

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone git@github.com:7893/pic.git
cd pic

# å®‰è£…ä¾èµ–
npm install
```

### é…ç½®

```bash
# 1. é…ç½® Unsplash API Key
wrangler secret put UNSPLASH_API_KEY --config workers/pic-scheduler/wrangler.toml

# 2. åˆ›å»º R2 Bucketï¼ˆéƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
# wrangler r2 bucket create pic-r2

# 3. åˆ›å»º D1 æ•°æ®åº“
wrangler d1 create pic-d1
# è®°å½•è¿”å›çš„ database_idï¼Œæ›´æ–°åˆ°ä¸¤ä¸ª wrangler.toml æ–‡ä»¶

# 4. åº”ç”¨æ•°æ®åº“ schema
wrangler d1 execute pic-d1 --remote --file=workers/pic-scheduler/schema.sql
```

### éƒ¨ç½²

```bash
# éƒ¨ç½²æ‰€æœ‰æœåŠ¡
npm run deploy:all

# æˆ–å•ç‹¬éƒ¨ç½²
npm run deploy:scheduler  # åç«¯è°ƒåº¦å™¨
npm run deploy:frontend   # å‰ç«¯å±•ç¤º
```

### éªŒè¯

```bash
# æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å¤„ç†
curl -X POST https://<your-worker>.workers.dev/api/trigger

# æŸ¥çœ‹ç»Ÿè®¡
curl https://<your-frontend>.workers.dev/api/stats

# è®¿é—®å‰ç«¯
open https://<your-frontend>.workers.dev
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
pic/
â”œâ”€â”€ .github/workflows/      # GitHub Actions CI/CD
â”œâ”€â”€ docs/                   # æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ API.md             # API æ¥å£æ–‡æ¡£
â”‚   â”œâ”€â”€ DEPLOY.md          # éƒ¨ç½²æŒ‡å—
â”‚   â””â”€â”€ TROUBLESHOOTING.md # æ•…éšœæ’æŸ¥
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ test.sh            # ç³»ç»Ÿæµ‹è¯•è„šæœ¬
â”œâ”€â”€ workers/
â”‚   â”œâ”€â”€ pic-scheduler/     # åç«¯è°ƒåº¦å™¨
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ workflows/ # Workflow å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ tasks/     # ä»»åŠ¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ services/  # å¤–éƒ¨æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ utils/     # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ schema.sql     # D1 æ•°æ®åº“ schema
â”‚   â”‚   â””â”€â”€ wrangler.toml  # Worker é…ç½®
â”‚   â””â”€â”€ pic-frontend/      # å‰ç«¯å±•ç¤º
â”‚       â”œâ”€â”€ src/index.js   # ä¸»å…¥å£
â”‚       â””â”€â”€ wrangler.toml  # Worker é…ç½®
â”œâ”€â”€ package.json           # æ ¹å·¥ä½œåŒºé…ç½®
â”œâ”€â”€ .tool-versions         # asdf ç‰ˆæœ¬é”å®š
â””â”€â”€ .nvmrc                 # Node ç‰ˆæœ¬é”å®š
```

## ğŸ—ï¸ æ¶æ„

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cron Trigger    â”‚  æ¯å°æ—¶è§¦å‘
â”‚  (Scheduler)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. Fetch 30 photos from Unsplash (regular quality)
         â”‚ 2. Filter duplicates (check DB)
         â”‚ 3. Insert to ProcessingQueue
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Photo Processing Workflow           â”‚
â”‚  (DataPipelineWorkflow)              â”‚
â”‚  - Batch process from queue          â”‚
â”‚  - Per photo, idempotent             â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 1: Download Image         â”‚ â”‚
â”‚  â”‚  - Fetch from Unsplash         â”‚ â”‚
â”‚  â”‚  - Use regular quality (~500KB)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 2: AI Classify            â”‚ â”‚
â”‚  â”‚  - Call Cloudflare AI          â”‚ â”‚
â”‚  â”‚  - Get category label          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 3: Upload to R2           â”‚ â”‚
â”‚  â”‚  - Save to category/{id}.jpg   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 4: Save to Database       â”‚ â”‚
â”‚  â”‚  - INSERT INTO Photos          â”‚ â”‚
â”‚  â”‚  - UPDATE CategoryStats        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  D1 + R2         â”‚  æŒä¹…åŒ–å­˜å‚¨
â”‚  (Photos + Files)â”‚
â”‚                  â”‚
â”‚  Auto Cleanup:   â”‚
â”‚  Keep 4,000 max  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

**1. Cron Workerï¼ˆè°ƒåº¦å™¨ï¼‰**
- æ¯å°æ—¶è§¦å‘ä¸€æ¬¡
- ä» Unsplash è·å–æœ€æ–°ç…§ç‰‡ï¼ˆ30 å¼ ï¼‰
- æ•°æ®åº“å»é‡
- æ’å…¥åˆ° ProcessingQueue
- è‡ªåŠ¨æ¸…ç†è¶…å‡ºé™åˆ¶çš„æ—§ç…§ç‰‡

**2. DataPipeline Workflowï¼ˆå¤„ç†æ ¸å¿ƒï¼‰**
- æ‰¹é‡å¤„ç†é˜Ÿåˆ—ä¸­çš„ç…§ç‰‡
- æ­¥éª¤çº§é‡è¯•ï¼ˆä¸‹è½½æˆåŠŸåæ— éœ€é‡ä¸‹ï¼‰
- å¹‚ç­‰æ€§ä¿è¯ï¼ˆæ£€æŸ¥ Photos è¡¨é¿å…é‡å¤ï¼‰
- çŠ¶æ€è‡ªåŠ¨æŒä¹…åŒ–

### æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| è®¡ç®— | Cloudflare Workers | æ— æœåŠ¡å™¨å‡½æ•° |
| æ•°æ®åº“ | D1 (SQLite) | å…ƒæ•°æ®å­˜å‚¨ |
| å­˜å‚¨ | R2 | å›¾ç‰‡æ–‡ä»¶å­˜å‚¨ |
| ç¼–æ’ | Workflows | å¤šæ­¥éª¤ä»»åŠ¡ç¼–æ’ |
| AI | Cloudflare AI | å›¾ç‰‡åˆ†ç±» |
| ç›‘æ§ | Analytics Engine | äº‹ä»¶è¿½è¸ª |

### æ•°æ®æµ

1. **Cron è§¦å‘**ï¼ˆæ¯å°æ—¶ï¼‰
   - è°ƒç”¨ Unsplash API è·å– 30 å¼ ç…§ç‰‡ï¼ˆregular è´¨é‡ï¼‰
   - æŸ¥è¯¢æ•°æ®åº“è¿‡æ»¤å·²å­˜åœ¨çš„ç…§ç‰‡
   - å°†æ–°ç…§ç‰‡æ’å…¥åˆ° ProcessingQueue
   - æ£€æŸ¥å¹¶æ¸…ç†è¶…å‡º 4,000 å¼ é™åˆ¶çš„æ—§ç…§ç‰‡

2. **Workflow å¤„ç†**
   - ä» ProcessingQueue æ‰¹é‡è·å–å¾…å¤„ç†ç…§ç‰‡
   - ä¸ºæ¯å¼ ç…§ç‰‡æ‰§è¡Œ 4 æ­¥å¤„ç†æµç¨‹
   - Step 1: ä¸‹è½½å›¾ç‰‡ï¼ˆ~500 KB regular è´¨é‡ï¼‰
   - Step 2: è°ƒç”¨ AI æ¨¡å‹è¿›è¡Œåˆ†ç±»
   - Step 3: ä¸Šä¼ åˆ° R2ï¼ˆcategory/{id}.jpgï¼‰
   - Step 4: ä¿å­˜å…ƒæ•°æ®åˆ° D1 æ•°æ®åº“

3. **å‰ç«¯å±•ç¤º**
   - ä» D1 è¯»å–ç…§ç‰‡åˆ—è¡¨
   - ä» R2 åŠ è½½å›¾ç‰‡æ–‡ä»¶
   - å±•ç¤ºç»Ÿè®¡ä¿¡æ¯å’Œåˆ†ç±»

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **å¤„ç†èƒ½åŠ›**ï¼š30 å¼ ç…§ç‰‡/å°æ—¶ = 720 å¼ /å¤©
- **API è°ƒç”¨**ï¼š1 æ¬¡/å°æ—¶ = 24 æ¬¡/å¤©ï¼ˆUnsplash é™åˆ¶ 50 æ¬¡/å°æ—¶ï¼‰
- **AI æ¨ç†**ï¼š2 æ¨¡å‹ Ã— 720 å¼  = 1,440 æ¬¡/å¤©
- **æˆåŠŸç‡**ï¼š~100%ï¼ˆWorkflow è‡ªåŠ¨é‡è¯•ï¼‰
- **å­˜å‚¨ä¼˜åŒ–**ï¼šä½¿ç”¨ regular è´¨é‡ï¼ˆ~500 KB vs 2-5 MB rawï¼‰

### Cloudflare å…è´¹å¥—é¤èµ„æºä½¿ç”¨

| èµ„æº | é™åˆ¶ | ä½¿ç”¨é‡ | çŠ¶æ€ |
|------|------|--------|------|
| Workers è¯·æ±‚ | 10 ä¸‡æ¬¡/å¤© | < 3 åƒæ¬¡/å¤© | âœ… å……è¶³ |
| D1 è¯»å†™ | 500 ä¸‡æ¬¡/å¤© | < 30 ä¸‡æ¬¡/æœˆ | âœ… å……è¶³ |
| R2 å­˜å‚¨ | 10 GB | ~2 GB | âœ… å……è¶³ |
| R2 æ“ä½œ | 100 ä¸‡æ¬¡/æœˆ | ~4.3 ä¸‡æ¬¡/æœˆ | âœ… å……è¶³ |
| Workflows æ­¥æ•° | 10 ä¸‡æ­¥/æœˆ | ~8.6 ä¸‡æ­¥/æœˆ | âœ… åˆç† |
| AI æ¨ç† | æ— é™åˆ¶ | 1,440 æ¬¡/å¤© | âœ… å…è´¹ |

**ç¨³å®šçŠ¶æ€**ï¼šä¿æŒ 4,000 å¼ ç…§ç‰‡ï¼Œçº¦ 2 GB å­˜å‚¨ï¼Œå®Œå…¨å…è´¹è¿è¡Œã€‚

## ğŸ› ï¸ å¼€å‘

```bash
# æœ¬åœ°å¼€å‘
npm run dev:scheduler  # å¯åŠ¨è°ƒåº¦å™¨ï¼ˆç«¯å£ 8787ï¼‰
npm run dev:frontend   # å¯åŠ¨å‰ç«¯ï¼ˆç«¯å£ 8788ï¼‰

# æŸ¥çœ‹æ—¥å¿—
wrangler tail pic-scheduler
wrangler tail pic-frontend

# æ•°æ®åº“æ“ä½œ
wrangler d1 execute pic-d1 --remote --command "SELECT COUNT(*) FROM Photos"

# æµ‹è¯•
npm test  # è¿è¡Œå•å…ƒæµ‹è¯•
./scripts/test.sh  # ç³»ç»Ÿé›†æˆæµ‹è¯•
```

## ğŸ“– æ–‡æ¡£

- [API æ–‡æ¡£](docs/API.md) - å‰åç«¯ API æ¥å£è¯´æ˜
- [éƒ¨ç½²æŒ‡å—](docs/DEPLOY.md) - å®Œæ•´éƒ¨ç½²æ­¥éª¤å’Œé…ç½®
- [æ•…éšœæ’æŸ¥](docs/TROUBLESHOOTING.md) - å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

## ğŸ”— åœ¨çº¿æ¼”ç¤º

- **å‰ç«¯**ï¼šhttps://pic.53.workers.dev
- **API**ï¼šhttps://pic-scheduler.53.workers.dev/api/stats

> æ³¨æ„ï¼šè¿™æ˜¯ä½œè€…çš„éƒ¨ç½²å®ä¾‹ï¼Œä½ éœ€è¦éƒ¨ç½²è‡ªå·±çš„ç‰ˆæœ¬ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼ˆ`git checkout -b feature/amazing-feature`ï¼‰
3. æäº¤æ›´æ”¹ï¼ˆ`git commit -m 'Add amazing feature'`ï¼‰
4. æ¨é€åˆ°åˆ†æ”¯ï¼ˆ`git push origin feature/amazing-feature`ï¼‰
5. å¼€å¯ Pull Request

è¯¦è§ [è´¡çŒ®æŒ‡å—](CONTRIBUTING.md)

## ğŸ“ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ™ è‡´è°¢

- [Unsplash](https://unsplash.com/) - æä¾›é«˜è´¨é‡ç…§ç‰‡ API
- [Cloudflare](https://cloudflare.com/) - æä¾›æ— æœåŠ¡å™¨å¹³å°
