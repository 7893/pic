# 接口指南、交互契约与防御性 API 设计 (03-API-REFERENCE)

Lens 的接口设计不仅仅是为了传递数据，更是一套**“为了在边缘侧极致压榨性能”**而生的交互契约。我们利用 Hono 框架构建了一个具备多层防御、动态截断和自动重排能力的工业级网关。

---

## 1. 核心搜索接口：`GET /api/search`

这是 Lens 系统的“明珠”，它在后台默默执行着四维空间的坐标比对与重排。

### 1.1 请求参数与业务考量

- **`q` (必填)**：支持高度口语化、文学化的描述。Llama 4 的查询扩展层会将这种输入转化为“视觉词向量”。
- **`limit` (可选)**：默认 20。系统会根据后台的“断崖检测”算法动态调整返回数量，即便你请求了 100，如果相关性不足，系统也可能只返回最优质的 15 条。

### 1.2 搜索生命周期的深度追踪 (Trace Lifecycle)

每一次点击“搜索”，系统内部都会发生以下连锁反应：

1.  **L1 Cache (Browser & Edge)**：检查 `caches.default`。
2.  **L2 Cache (KV Semantic)**：将用户词通过 `normalizeQuery` 后去 KV 匹配。
3.  **Query Expansion**：若未命中，由 **Llama 3.2 3B** 执行翻译与联想。
4.  **Vectorized Query**：BGE-M3 在向量库执行 `topK: 100` 的召回。
5.  **The "Cliff Detection" (动态截断)**：
    - **数学逻辑**：遍历这 100 张图的分数。计算相邻分数的变化率：`Ratio = score[i] / score[i-1]`。
    - **熔断触发**：一旦 `Ratio < 0.8` 或 `score < 0.5`，系统判定已进入“语义长尾”，直接在此处斩断结果集。
    - **收益**：避免用户看到不相关的图，同时节省了昂贵的 Reranker 计算开销。
6.  **BGE Reranker Base (精排)**：对截断后的前 20 张图进行像素级打分。
    - **防御性处理**：代码会自动兼容 Reranker 返回的 `id` 或 `index` 格式，并执行边界检查，彻底杜绝了 AI 响应异常导致的数组越界。

### 1.3 旗舰版响应字段定义

我们不仅仅返回 URL，我们返回的是**图片的“简历”**：

- **`ai_quality_score`**：0-10 分。让前端可以根据“美感”进行二次视觉分流。
- **`entities`**：AI 识别出的高价值实体。例如 `["Empire State Building", "Tesla Model 3"]`。
- **`color`**：用于实现 UI 上的 **“色块渐变进入 (Color Fade-in)”** 效果。

---

## 2. 图片详情与安全出口：`/api/images/:id`

这是一个“全信息脱敏”接口。它将 D1 中复杂的 `meta_json` 进行优雅降级处理，只吐出对用户有用的摄影参数、地点和 AI 见解。

### 2.1 EXIF 的逻辑重组

系统会自动从 Unsplash 的原始数据中提取：

- `camera`: 整合品牌与型号。
- `exposure`: 自动格式化快门速度（如 1/125s）。
- `iso`: 原始感光度数据。
- **意义**：这些数据让 Lens 不仅仅是一个“搜图工具”，更像是一个摄影爱好者的“灵感画廊”。

---

## 3. R2 镜像出口：`/image/:type/:filename`

这是一个**“零费用”设计**的典范。

- **ETag 与 Immutable**：通过计算图片流的 MD5 生成 ETag。
- **缓存穿透保护**：系统禁止任何非 `.jpg` 后缀的访问，保护 R2 的读取配额不被恶意扫描器消耗。
- **分流逻辑**：
  - `type=raw`：走大流量通道，用于存档。
  - `type=display`：走极速通道，服务于 UI。

---

## 4. 故障模型与全局状态码

| 状态码                    | 故障隐喻                                               | 建议对策                                                 |
| :------------------------ | :----------------------------------------------------- | :------------------------------------------------------- |
| **429 (Sliding Window)**  | 用户的搜索欲望过强，超出 AI 预算。                     | 提升 Cache TTL 或引导用户稍微等待。                      |
| **504 (Gateway Timeout)** | Llama 4 在边缘侧忙碌或排队中。                         | 系统会自动尝试 Workflow 重试，前端显示“正在深度加载中”。 |
| **404 (Zombie ID)**       | 锚点 `last_seen_id` 存在但 R2 资产已由于不可抗力丢失。 | 采集引擎会自动探测并修复该记录。                         |
